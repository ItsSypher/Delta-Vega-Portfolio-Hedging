# Options Data Format

This document describes the output data format generated by the options time-series pipeline.

## Output Files

**Raw Data:** `data/output/options_timeseries.csv`
**Filled Data:** `data/output/options_timeseries_filled.csv` and `.xlsx`

The filled version includes:
- Interpolated prices for missing data points
- Computed Greeks/IV using Black-Scholes where missing
- All values rounded to 4 decimal places

## Column Reference

### Identification Columns

| Column | Type | Description |
|--------|------|-------------|
| `ticker` | string | Eikon RIC for the underlying (e.g., `AAPL.O`) |
| `date` | date | Trading date (YYYY-MM-DD) |
| `expiry` | date | Option expiration date (3rd Friday) |
| `dte` | int | Days to expiration from this date |
| `strike` | float | Option strike price ($5 increments) |
| `underlying_close` | float | Underlying stock closing price |

### Call Option Data

| Column | Type | Description |
|--------|------|-------------|
| `call_close` | float | Closing/trade price |
| `call_close_interpolated` | bool | True if close was interpolated |
| `call_bid` | float | Bid price |
| `call_ask` | float | Ask price |
| `call_iv` | float | Implied volatility (percentage, e.g., 25.5 = 25.5%) |
| `call_delta` | float | Delta (0 to 1 for calls) |
| `call_gamma` | float | Gamma |
| `call_vega` | float | Vega |
| `call_theta` | float | Theta |
| `call_volume` | int | Trading volume |
| `call_computed` | bool | True if Greeks were computed via Black-Scholes |

### Put Option Data

| Column | Type | Description |
|--------|------|-------------|
| `put_close` | float | Closing/trade price |
| `put_close_interpolated` | bool | True if close was interpolated |
| `put_bid` | float | Bid price |
| `put_ask` | float | Ask price |
| `put_iv` | float | Implied volatility (percentage) |
| `put_delta` | float | Delta (-1 to 0 for puts) |
| `put_gamma` | float | Gamma |
| `put_vega` | float | Vega |
| `put_theta` | float | Theta |
| `put_volume` | int | Trading volume |
| `put_computed` | bool | True if Greeks were computed via Black-Scholes |

### Metadata Columns

| Column | Type | Description |
|--------|------|-------------|
| `nan_percent` | float | Percentage of NaN values in the row |

## Data Structure

Each row represents **one trading day for one strike price**, containing call and put data for that day.

```
┌─────────────────────────────────────────────────────────────────┐
│  One Row = One Date + One Strike                                │
├─────────────────────────────────────────────────────────────────┤
│  Identification: ticker, date, expiry, dte, strike,            │
│                  underlying_close                               │
│                                                                 │
│  Call Data:                                                     │
│    close, bid, ask, iv, delta, gamma, vega, theta, volume      │
│    + interpolated/computed flags                                │
│                                                                 │
│  Put Data:                                                      │
│    close, bid, ask, iv, delta, gamma, vega, theta, volume      │
│    + interpolated/computed flags                                │
└─────────────────────────────────────────────────────────────────┘
```

## Time Series Coverage

For each ticker/expiry combination:
- **Start:** ~60 trading days before expiration
- **End:** Expiration date
- **Granularity:** Daily

## Data Filling Process

The `fill_greeks.py` script processes the raw data:

1. **Underlying Price Interpolation**: Missing underlying prices are interpolated across all dates for each ticker (across expiry boundaries).

2. **Option Price Interpolation**: Missing call/put close prices are linearly interpolated within each ticker/expiry/strike group along the time dimension.

3. **Greeks Computation**: For rows with close prices but missing Greeks, Black-Scholes formulas compute:
   - Implied Volatility (via Brent's method)
   - Delta, Gamma, Vega, Theta
   
4. **NaN Recalculation**: The `nan_percent` column is recalculated after filling.

## Example Data

```csv
ticker,date,expiry,dte,strike,underlying_close,call_close,call_close_interpolated,call_bid,call_ask,call_iv,call_delta,call_gamma,call_vega,call_theta,call_volume,call_computed,put_close,put_close_interpolated,put_bid,put_ask,put_iv,put_delta,put_gamma,put_vega,put_theta,put_volume,put_computed,nan_percent
AAPL.O,2023-12-18,2024-03-15,88,185,195.89,16.49,False,16.2,16.4,21.9308,0.7575,0.015,0.3159,-0.0596,282.0,False,3.1,False,3.15,3.2,21.6254,-0.2468,0.0157,0.3169,-0.0317,1806.0,False,0.0
AAPL.O,2023-12-18,2024-03-15,88,190,195.89,12.64,False,12.6,12.7,21.1707,0.6786,0.0179,0.3565,-0.0603,424.0,False,4.3,False,4.4,4.5,20.7038,-0.3299,0.0191,0.3377,-0.03,883.0,False,0.0
```

## Configuration Reference

The data is generated based on `config/settings.yaml`:

```yaml
tickers:                    # List of Eikon RICs
  - AAPL.O
  - MSFT.O

maturity_dates:             # Option expiration dates (YYYY-MM-DD)
  - 2024-03-15              # March 2024 monthly expiry
  - 2024-06-21              # June 2024 monthly expiry

settings:
  lookback_trading_days: 60 # Days of history before expiry
  strike_increment: 5       # $5 strike spacing
  strikes_around_atm: 2     # 2 above + 2 below ATM
```

## Notes

1. **Time Series Nature**: Each row is a single observation date. You get the full evolution of prices/Greeks from ~60 days before expiry until expiration.

2. **Strike Selection**: Strikes are determined at the start of the lookback period based on the stock price at that time, centered around ATM (rounded to nearest $5).

3. **Greeks Evolution**: You can observe how delta, gamma, vega, theta, and IV evolve as the option approaches expiration.

4. **DTE Column**: Days to expiration decreases from ~60 to 0 as you progress through time for each strike.

5. **Interpolation Flags**: The `*_interpolated` columns indicate which close prices were filled via linear interpolation rather than from market data.

6. **Computed Flags**: The `*_computed` columns indicate which Greeks/IV were calculated using Black-Scholes rather than from the data source.

7. **Edge Cases**: Greeks cannot be computed for options trading below intrinsic value (negative time value), as IV is undefined in these cases.
